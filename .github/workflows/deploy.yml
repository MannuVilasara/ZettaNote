name: Build and Deploy

on:
    push:
        branches:
            - main
            - dev
    workflow_dispatch:

jobs:
    build-frontend:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install frontend dependencies
              working-directory: ./frontend
              run: pnpm install

            - name: Build frontend
              working-directory: ./frontend
              run: pnpm run build

            - name: Upload frontend build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-build
                  path: frontend/build/
                  retention-days: 7

    build-admin-portal:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install admin-portal dependencies
              working-directory: ./admin-portal
              run: pnpm install

            - name: Build admin-portal
              working-directory: ./admin-portal
              run: pnpm run build

            - name: Upload admin-portal build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: admin-portal-build
                  path: admin-portal/build/
                  retention-days: 7

    deploy:
        needs: [build-frontend, build-admin-portal]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        steps:
            - name: Download frontend artifact
              uses: actions/download-artifact@v4
              with:
                  name: frontend-build
                  path: ./artifacts/frontend

            - name: Download admin-portal artifact
              uses: actions/download-artifact@v4
              with:
                  name: admin-portal-build
                  path: ./artifacts/admin-portal

            - name: Trigger deployment on server
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  script: |
                      cd ${{ secrets.DEPLOY_PATH || '/opt/zettanote' }}
                      ./deploy.sh ${{ github.run_number }} ${{ github.sha }}

            - name: Upload artifacts to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  source: "artifacts/*"
                  target: ${{ secrets.DEPLOY_PATH || '/opt/zettanote' }}/releases/${{ github.run_number }}
                  strip_components: 1
