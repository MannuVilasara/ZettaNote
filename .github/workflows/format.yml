name: Check Formatting

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  prettier:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install Prettier
        run: pnpm add -g prettier

      - name: Check Formatting
        id: prettier-check
        continue-on-error: true
        run: prettier --check "**/*.{js,jsx,json,css,md,yml,yaml}" --ignore-path .prettierignore

      - name: Comment on PR if formatting failed
        if: steps.prettier-check.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå Code Formatting Check Failed

            Your code has formatting issues that need to be fixed.

            ### üîß How to fix:

            Run this command locally to fix all formatting issues:
            \`\`\`bash
            npx prettier --write "**/*.{js,jsx,json,css,md,yml,yaml}" --ignore-path .prettierignore
            \`\`\`

            Or use pnpm:
            \`\`\`bash
            pnpm prettier --write "**/*.{js,jsx,json,css,md,yml,yaml}" --ignore-path .prettierignore
            \`\`\`

            Then commit and push your changes to re-run this check.

            **Tip:** Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) to see which files need formatting.

            ---
            *This check is automated. Please ensure all files are formatted before merging.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail the job if formatting check failed
        if: steps.prettier-check.outcome == 'failure'
        run: |
          echo "‚ùå Formatting check failed! Please fix the formatting issues."
          exit 1
